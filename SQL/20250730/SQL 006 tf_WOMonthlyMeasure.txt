
create FUNCTION [dbo].[tf_WOMonthlyMeasure]
(
@WODataFrom DateTime,
@WODataTo DateTime
)
RETURNS
	@newtable TABLE
	(
	  ID int, 
	  AnalysisName nvarchar(200), 
	  AnalysisRemarks nvarchar(10), 
	  PG nvarchar(100),
	  DocDate datetime,
	  DocID int,
	  TargetKPI int,
	  Done int
	)

begin
	--Create = 0,
    --DocPassed = 1,
    --Approved = 2,
    --Cancelled = 3,
    --Rejected = 4,
    --Closed = 5,
    --Active = 6,
    --Posted = 7
	declare @space nvarchar(2) = '     '
	declare @id int
	declare @temp int
	declare @temp2 int
	declare @analysisname nvarchar(200)
	declare @analysisremarks nvarchar(10)
	declare @targetkpi numeric(10,2)
	declare @temptable table
	(
		id int
	)
	begin -- PM
		set @id = 0
		set @analysisname = 'Preventive Maintenance'
		set @analysisremarks = ''
		select @targetkpi = 0

		insert into @newtable
		select @id, @analysisname, @analysisremarks, null, null, 0
		,@targetkpi, 0

		if not exists(select top 1 ID from @newtable where ID = @id)
		begin
			insert into @newtable
			select @id, @analysisname, @analysisremarks, null, null, 0
			,@targetkpi, 0
		end
		--------------------------------------------------------

		set @id = 1
		set @analysisname = @space + 'PM Planned Monthly'
		set @analysisremarks = '-'
		select @targetkpi = 0

		insert into @newtable
		select @id, @analysisname, @analysisremarks, T11.BoCode, T0.PlanStartDate, T0.ID
		,@targetkpi, 1
		from WorkOrders T0 inner join PlannerGroups T11 on T0.AssignPlannerGroup_ID = T11.ID
		where T0.IsPreventiveMaintenance = 1
		and T0.Cancelled = 0
		and T0.PlanStartDate >= @WODataFrom and T0.PlanStartDate <= @WODataTo

		--if not exists(select top 1 ID from @newtable where ID = @id)
		--begin
			insert into @newtable
			select @id, @analysisname, @analysisremarks, null, null, 0
			,@targetkpi, 0
		--end
		--------------------------------------------------------

		set @id = 2
		set @analysisname = @space + 'PM Planned Backlog'
		set @analysisremarks = '-'
		select @targetkpi = 0

		insert into @newtable
		select @id, @analysisname, @analysisremarks, T11.BoCode, T0.PlanStartDate, T0.ID
		,@targetkpi, 1
		from WorkOrders T0 inner join PlannerGroups T11 on T0.AssignPlannerGroup_ID = T11.ID
		where T0.IsPreventiveMaintenance = 1
		and T0.Cancelled = 0
		and T0.IsClosed = 0
		and (T0.PlanEndDate is not null and T0.PlanEndDate < @WODataFrom)

		--if not exists(select top 1 ID from @newtable where ID = @id)
		--begin
			insert into @newtable
			select @id, @analysisname, @analysisremarks, null, null, 0
			,@targetkpi, 0
		--end
		--------------------------------------------------------

		set @id = 3
		set @analysisname = @space + 'PM Planned Total'
		set @analysisremarks = '-'
		select @targetkpi = 0

		insert into @newtable
		select @id, @analysisname, @analysisremarks, PG, DocDate, DocID
		,@targetkpi, Done
		from @newtable
		where ID in (1,2)

		if not exists(select top 1 ID from @newtable where ID = @id)
		begin
			insert into @newtable
			select @id, @analysisname, @analysisremarks, null, null, 0
			,@targetkpi, 0
		end
		--------------------------------------------------------

		set @id = 4
		set @analysisname = @space + @space + 'PM Scheduled Total'
		set @analysisremarks = '-'
		select @targetkpi = 0

		insert into @newtable
		select @id, @analysisname, @analysisremarks, T11.BoCode, T0.PlanStartDate, T0.ID
		,@targetkpi, 1
		from WorkOrders T0 inner join PlannerGroups T11 on T0.AssignPlannerGroup_ID = T11.ID
		where T0.IsPreventiveMaintenance = 1
		and T0.Cancelled = 0
		and (T0.ScheduleStartDate is not null and T0.ScheduleEndDate is not null)
		and ((T0.PlanStartDate >= @WODataFrom and T0.PlanStartDate <= @WODataTo)
		or (T0.IsClosed = 0 and (T0.PlanEndDate is not null and T0.PlanEndDate < @WODataFrom)))

		--if not exists(select top 1 ID from @newtable where ID = @id)
		--begin
			insert into @newtable
			select @id, @analysisname, @analysisremarks, null, null, 0
			,@targetkpi, 0
		--end
		--------------------------------------------------------

		set @id = 5
		set @analysisname = @space + @space + @space + 'PM Scheduled Compliance'
		set @analysisremarks = '-'
		select @targetkpi = 70

		insert into @newtable
		select @id, @analysisname, @analysisremarks, T11.BoCode, T0.PlanStartDate, T0.ID
		,@targetkpi, 1
		from WorkOrders T0 inner join PlannerGroups T11 on T0.AssignPlannerGroup_ID = T11.ID
		where T0.IsPreventiveMaintenance = 1
		and T0.Cancelled = 0
		and (T0.ScheduleStartDate is not null and T0.ScheduleEndDate is not null)
		and ((T0.PlanStartDate >= @WODataFrom and T0.PlanStartDate <= @WODataTo)
		or (T0.IsClosed = 0 and (T0.PlanEndDate is not null and T0.PlanEndDate < @WODataFrom)))
		and ((T0.RescheduleStartDate is null and T0.ScheduleStartDate <= T0.ActualEndDate and T0.ScheduleEndDate >= T0.ActualEndDate)
		or (T0.RescheduleStartDate is not null and T0.ReScheduleStartDate <= T0.ActualEndDate and T0.ReScheduleEndDate >= T0.ActualEndDate))

		--if not exists(select top 1 ID from @newtable where ID = @id)
		--begin
			insert into @newtable
			select @id, @analysisname, @analysisremarks, null, null, 0
			,@targetkpi, 0
		--end
		--------------------------------------------------------
		set @id = 6
		set @analysisname = @space + @space + @space + 'PM Planned Non-Compliance'
		set @analysisremarks = '-'
		select @targetkpi = 0
		
		;with cte as
		(
			select PG, DocDate, DocID, sum(case when ID = 4 then 1 when ID = 5 then -1 else 0 end) as done
			from @newtable
			where ID in (4,5)
			group by PG, DocDate, DocID
		)
		insert into @newtable
		select @id, @analysisname, @analysisremarks, PG, DocDate, DocID
		,@targetkpi, Done
		from cte
		where Done > 0

		if not exists(select top 1 ID from @newtable where ID = @id)
		begin
			insert into @newtable
			select @id, @analysisname, @analysisremarks, null, null, 0
			,@targetkpi, 0
		end
		--------------------------------------------------------

		set @id = 7
		set @analysisname = @space + @space + 'PM Not Scheduled Total'
		set @analysisremarks = '-'
		select @targetkpi = 0

		;with cte as
		(
			select PG, DocDate, DocID, sum(case when ID = 3 then 1 when ID = 4 then -1 else 0 end) as done
			from @newtable
			where ID in (3,4)
			group by PG, DocDate, DocID
		)
		insert into @newtable
		select @id, @analysisname, @analysisremarks, PG, DocDate, DocID
		,@targetkpi, Done
		from cte
		where Done > 0

		if not exists(select top 1 ID from @newtable where ID = @id)
		begin
			insert into @newtable
			select @id, @analysisname, @analysisremarks, null, null, 0
			,@targetkpi, 0
		end
		--------------------------------------------------------

		set @id = 8
		set @analysisname = @space + 'PM Planned Compliance'
		set @analysisremarks = '-'
		select @targetkpi = 100

		insert into @newtable
		select @id, @analysisname, @analysisremarks, T11.BoCode, T0.PlanStartDate, T0.ID
		,@targetkpi, 1
		from WorkOrders T0 inner join PlannerGroups T11 on T0.AssignPlannerGroup_ID = T11.ID
		where T0.IsPreventiveMaintenance = 1
		and T0.IsClosed = 1	
		and T0.Cancelled = 0	
		and (T0.ScheduleStartDate is not null and T0.ScheduleEndDate is not null)
		and (T0.PlanStartDate >= @WODataFrom and T0.PlanStartDate <= @WODataTo)

		--if not exists(select top 1 ID from @newtable where ID = @id)
		--begin
			insert into @newtable
			select @id, @analysisname, @analysisremarks, null, null, 0
			,@targetkpi, 0
		--end
		--------------------------------------------------------

		set @id = 9
		set @analysisname = @space + 'PM Planned Non Compliance'
		set @analysisremarks = '-'
		select @targetkpi = 0

		;with cte as
		(
			select PG, DocDate, DocID, sum(case when ID = 3 then 1 when ID = 8 then -1 else 0 end) as done
			from @newtable
			where ID in (3,8)
			group by PG, DocDate, DocID
		)
		insert into @newtable
		select @id, @analysisname, @analysisremarks, PG, DocDate, DocID
		,@targetkpi, Done
		from cte
		where Done > 0

		if not exists(select top 1 ID from @newtable where ID = @id)
		begin
			insert into @newtable
			select @id, @analysisname, @analysisremarks, null, null, 0
			,@targetkpi, 0
		end
		--------------------------------------------------------

		set @id = 10
		set @analysisname = @space + @space + 'PM with Deviation'
		set @analysisremarks = '-'
		select @targetkpi = 0

		;with cte as (
			select PG, DocDate, DocID
			, Done
			from @newtable
			where ID = 9
		)
		insert into @newtable
		select @id, @analysisname, @analysisremarks, T0.PG, T0.DocDate, T0.DocID
		,@targetkpi 
		, 1
		from cte T0
		inner join Deviation2025 T10 on T0.DocID = T10.WorkOrder_ID
		group by T0.PG, T0.DocDate, T0.DocID, T10.WorkOrder_ID

		--if not exists(select top 1 ID from @newtable where ID = @id)
		--begin
			insert into @newtable
			select @id, @analysisname, @analysisremarks, null, null, 0
			,@targetkpi, 0
		--end
		--------------------------------------------------------

		set @id = 11
		set @analysisname = @space + @space + 'PM without Deviation'
		set @analysisremarks = '-'
		select @targetkpi = 0

		;with cte as
		(
			select PG, DocDate, DocID, sum(case when ID = 9 then 1 when ID = 10 then -1 else 0 end) as done
			from @newtable
			where ID in (9,10)
			group by PG, DocDate, DocID
		)
		insert into @newtable
		select @id, @analysisname, @analysisremarks, PG, DocDate, DocID
		,@targetkpi, Done
		from cte
		where Done > 0

		if not exists(select top 1 ID from @newtable where ID = @id)
		begin
			insert into @newtable
			select @id, @analysisname, @analysisremarks, null, null, 0
			,@targetkpi, 0
		end
	end

	begin -- CM
		set @id = 100
		set @analysisname = 'Corrective Maintenance'
		set @analysisremarks = ''
		select @targetkpi = 0

		insert into @newtable
		select @id, @analysisname, @analysisremarks, '', null, 0
		,0, 0

		if not exists(select top 1 ID from @newtable where ID = @id)
		begin
			insert into @newtable
			select @id, @analysisname, @analysisremarks, null, null, 0
			,@targetkpi, 0
		end
		--------------------------------------------------------

		set @id = 101
		set @analysisname = @space + 'CM Planned Monthly'
		set @analysisremarks = '-'
		select @targetkpi = 0

		insert into @newtable
		select @id, @analysisname, @analysisremarks, T11.BoCode, T0.DocDate, T0.ID
		,@targetkpi, 1
		from WorkOrders T0 inner join PlannerGroups T11 on T0.AssignPlannerGroup_ID = T11.ID
		where T0.IsPreventiveMaintenance = 0
		and T0.Cancelled = 0
		and T0.PlanStartDate >= @WODataFrom and T0.PlanStartDate <= @WODataTo

		--if not exists(select top 1 ID from @newtable where ID = @id)
		--begin
			insert into @newtable
			select @id, @analysisname, @analysisremarks, null, null, 0
			,@targetkpi, 0
		--end
		--------------------------------------------------------

		set @id = 102
		set @analysisname = @space + 'CM Planned Backlog'
		set @analysisremarks = '-'
		select @targetkpi = 0

		insert into @newtable
		select @id, @analysisname, @analysisremarks, T11.BoCode, T0.DocDate, T0.ID
		,@targetkpi, 1
		from WorkOrders T0 inner join PlannerGroups T11 on T0.AssignPlannerGroup_ID = T11.ID
		where T0.IsPreventiveMaintenance = 0
		and T0.Cancelled = 0
		and T0.IsClosed = 0
		and (T0.PlanEndDate is not null and T0.PlanEndDate < @WODataFrom)

		--if not exists(select top 1 ID from @newtable where ID = @id)
		--begin
			insert into @newtable
			select @id, @analysisname, @analysisremarks, null, null, 0
			,@targetkpi, 0
		--end
		--------------------------------------------------------

		set @id = 103
		set @analysisname = @space + 'CM Planned Total'
		set @analysisremarks = '-'
		select @targetkpi = 0

		insert into @newtable
		select @id, @analysisname, @analysisremarks, PG, DocDate, DocID
		,@targetkpi, Done
		from @newtable
		where ID in (101,102)

		if not exists(select top 1 ID from @newtable where ID = @id)
		begin
			insert into @newtable
			select @id, @analysisname, @analysisremarks, null, null, 0
			,@targetkpi, 0
		end
		--------------------------------------------------------

		set @id = 104
		set @analysisname = @space + @space + 'CM Scheduled Total'
		set @analysisremarks = '-'
		select @targetkpi = 0

		insert into @newtable
		select @id, @analysisname, @analysisremarks, T11.BoCode, T0.DocDate, T0.ID
		,@targetkpi, 1
		from WorkOrders T0 inner join PlannerGroups T11 on T0.AssignPlannerGroup_ID = T11.ID
		where T0.IsPreventiveMaintenance = 0
		and T0.Cancelled = 0
		and (T0.ScheduleStartDate is not null and T0.ScheduleEndDate is not null)
		and ((T0.PlanStartDate >= @WODataFrom and T0.PlanStartDate <= @WODataTo)
		or (T0.IsClosed = 0 and (T0.PlanEndDate is not null and T0.PlanEndDate < @WODataFrom)))

		--if not exists(select top 1 ID from @newtable where ID = @id)
		--begin
			insert into @newtable
			select @id, @analysisname, @analysisremarks, null, null, 0
			,@targetkpi, 0
		--end
		--------------------------------------------------------

		set @id = 105
		set @analysisname = @space + @space + @space + 'CM Scheduled Compliance'
		set @analysisremarks = '-'
		select @targetkpi = 70

		insert into @newtable
		select @id, @analysisname, @analysisremarks, T11.BoCode, T0.DocDate, T0.ID
		,@targetkpi, 1
		from WorkOrders T0 inner join PlannerGroups T11 on T0.AssignPlannerGroup_ID = T11.ID
		where T0.IsPreventiveMaintenance = 0
		and T0.Cancelled = 0
		and (T0.ScheduleStartDate is not null and T0.ScheduleEndDate is not null)
		and ((T0.PlanStartDate >= @WODataFrom and T0.PlanStartDate <= @WODataTo)
		or (T0.IsClosed = 0 and (T0.PlanEndDate is not null and T0.PlanEndDate < @WODataFrom)))
		and ((T0.RescheduleStartDate is null and T0.ScheduleStartDate <= T0.ActualEndDate and T0.ScheduleEndDate >= T0.ActualEndDate)
		or (T0.RescheduleStartDate is not null and T0.ReScheduleStartDate <= T0.ActualEndDate and T0.ReScheduleEndDate >= T0.ActualEndDate))

		--if not exists(select top 1 ID from @newtable where ID = @id)
		--begin
			insert into @newtable
			select @id, @analysisname, @analysisremarks, null, null, 0
			,@targetkpi, 0
		--end
		--------------------------------------------------------
		
		set @id = 106
		set @analysisname = @space + @space + @space + 'CM Planned Non-Compliance'
		set @analysisremarks = '-'
		select @targetkpi = 0
		
		;with cte as
		(
			select PG, DocDate, DocID, sum(case when ID = 104 then 1 when ID = 105 then -1 else 0 end) as done
			from @newtable
			where ID in (104,105)
			group by PG, DocDate, DocID
		)
		insert into @newtable
		select @id, @analysisname, @analysisremarks, PG, DocDate, DocID
		,@targetkpi, Done
		from cte
		where Done > 0

		if not exists(select top 1 ID from @newtable where ID = @id)
		begin
			insert into @newtable
			select @id, @analysisname, @analysisremarks, null, null, 0
			,@targetkpi, 0
		end
		--------------------------------------------------------

		set @id = 107
		set @analysisname = @space + @space + 'CM Not Scheduled Total'
		set @analysisremarks = '-'
		select @targetkpi = 0

		;with cte as
		(
			select PG, DocDate, DocID, sum(case when ID = 103 then 1 when ID = 104 then -1 else 0 end) as done
			from @newtable
			where ID in (103,104)
			group by PG, DocDate, DocID
		)
		insert into @newtable
		select @id, @analysisname, @analysisremarks, PG, DocDate, DocID
		,@targetkpi, Done
		from cte
		where Done > 0

		if not exists(select top 1 ID from @newtable where ID = @id)
		begin
			insert into @newtable
			select @id, @analysisname, @analysisremarks, null, null, 0
			,@targetkpi, 0
		end
		--------------------------------------------------------

		set @id = 108
		set @analysisname = @space + 'CM Planned Compliance'
		set @analysisremarks = '-'
		select @targetkpi = 100

		insert into @newtable
		select @id, @analysisname, @analysisremarks, T11.BoCode, T0.PlanStartDate, T0.ID
		,@targetkpi, 1
		from WorkOrders T0 inner join PlannerGroups T11 on T0.AssignPlannerGroup_ID = T11.ID
		where T0.IsPreventiveMaintenance = 0
		and T0.IsClosed = 1	
		and T0.Cancelled = 0	
		and (T0.ScheduleStartDate is not null and T0.ScheduleEndDate is not null)
		and (T0.PlanStartDate >= @WODataFrom and T0.PlanStartDate <= @WODataTo)

		--if not exists(select top 1 ID from @newtable where ID = @id)
		--begin
			insert into @newtable
			select @id, @analysisname, @analysisremarks, null, null, 0
			,@targetkpi, 0
		--end
		--------------------------------------------------------

		set @id = 109
		set @analysisname = @space + 'CM Planned Non Compliance'
		set @analysisremarks = '-'
		select @targetkpi = 0

		;with cte as
		(
			select PG, DocDate, DocID, sum(case when ID = 103 then 1 when ID = 108 then -1 else 0 end) as done
			from @newtable
			where ID in (103,108)
			group by PG, DocDate, DocID
		)
		insert into @newtable
		select @id, @analysisname, @analysisremarks, PG, DocDate, DocID
		,@targetkpi, Done
		from cte
		where Done > 0

		if not exists(select top 1 ID from @newtable where ID = @id)
		begin
			insert into @newtable
			select @id, @analysisname, @analysisremarks, null, null, 0
			,@targetkpi, 0
		end
		--------------------------------------------------------

		set @id = 110
		set @analysisname = @space + @space + 'CM with Deviation'
		set @analysisremarks = '-'
		select @targetkpi = 0

		;with cte as (
			select PG, DocDate, DocID
			, Done
			from @newtable
			where ID = 109
		)
		insert into @newtable
		select @id, @analysisname, @analysisremarks, T0.PG, T0.DocDate, T0.DocID
		,@targetkpi
		, 1
		from cte T0
		inner join Deviation2025 T10 on T0.DocID = T10.WorkOrder_ID
		group by T0.PG, T0.DocDate, T0.DocID

		--if not exists(select top 1 ID from @newtable where ID = @id)
		--begin
			insert into @newtable
			select @id, @analysisname, @analysisremarks, null, null, 0
			,@targetkpi, 0
		--end

		--------------------------------------------------------

		set @id = 111
		set @analysisname = @space + @space + 'CM without Deviation'
		set @analysisremarks = '-'
		select @targetkpi = 0

		;with cte as
		(
			select PG, DocDate, DocID, sum(case when ID = 109 then 1 when ID = 100 then -1 else 0 end) as done
			from @newtable
			where ID in (109,100)
			group by PG, DocDate, DocID
		)
		insert into @newtable
		select @id, @analysisname, @analysisremarks, PG, DocDate, DocID
		,@targetkpi, Done
		from cte
		where Done > 0

		if not exists(select top 1 ID from @newtable where ID = @id)
		begin
			insert into @newtable
			select @id, @analysisname, @analysisremarks, null, null, 0
			,@targetkpi, 0
		end
	end

	return

end
